generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum definice
enum UserRole {
  ADMIN
  B2B_CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum Unit {
  KS // kusy (prodejní jednotka)
  KG // kilogramy
  L // litry
  BAL // balení (1 bal = 6 ks)
}

// Uživatelé (B2B zákazníci + admin)
model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  role     UserRole @default(B2B_CUSTOMER)

  // B2B informace
  companyName String?
  ico         String? @unique // IČO firmy
  dic         String? // DIČ firmy
  phone       String?

  // Adresa
  street  String?
  city    String?
  zipCode String?
  country String? @default("Czech Republic")

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Vztahy
  orders       Order[]
  customPrices CustomPrice[]

  @@map("users")
}

// Kategorie produktů
model Category {
  id          String  @id @default(uuid())
  name        String  @unique
  slug        String  @unique
  description String?
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Vztahy
  products Product[]

  @@map("categories")
}

// Produkty
model Product {
  id          String   @id @default(cuid())
  name        String // Obecný název, např. "Sirup", "Jelly", "Bubble Tea Prášek"
  slug        String   @unique
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  variants ProductVariant[]

  @@index([categoryId])
}

// Individuální ceny pro B2B zákazníky
model CustomPrice {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  price Float // Speciální cena pro tohoto zákazníka

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productVariantId])
  @@map("custom_prices")
}

// Objednávky
model Order {
  id          String @id @default(uuid())
  orderNumber String @unique // Lidsky čitelné číslo objednávky

  // Zákazník
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Status a ceny
  status   OrderStatus @default(PENDING)
  subtotal Float // Součet položek
  shipping Float       @default(0)
  total    Float // Subtotal + shipping

  // Dodací adresa (může být jiná než u uživatele)
  shippingStreet  String?
  shippingCity    String?
  shippingZipCode String?
  shippingCountry String? @default("Czech Republic")

  // Platba
  paymentId     String? // ID z Comgate
  paymentMethod String? // "card", "apple_pay"
  paidAt        DateTime?

  // Poznámky
  customerNote String?
  adminNote    String?

  // Tracking
  trackingNumber String?
  shippedAt      DateTime?
  deliveredAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Vztahy
  items OrderItem[]

  @@map("orders")
}

// Položky objednávky
model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  quantity  Int
  unitPrice Float // Cena za jednotku v době objednávky
  total     Float // quantity * unitPrice

  @@map("order_items")
}

model Image {
  id        String   @id @default(cuid())
  url       String
  altText   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  @@index([productVariantId])
}

model ProductVariant {
  id   String  @id @default(cuid())
  name String // Celý název varianty pro zobrazení, např. "Waitansky Sirup - Borůvka 2.5kg"
  slug String  @unique
  sku  String? @unique

  // -- Atributy varianty --
  brand    String? // např. "Waitansky", "Monin"
  flavor   String? // např. "Borůvka", "Vanilka"
  weightKg Float? // Hmotnost v kg, např. 2.5
  volumeL  Float? // Objem v litrech, např. 0.7

  // -- Ceny a sklad --
  price         Float
  discountPrice Float?
  stockQuantity Int?
  isActive      Boolean @default(true)
  inStock       Boolean @default(true)
  isDefault     Boolean @default(false) // Varianta, která se zobrazí jako výchozí na detailu produktu

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // -- Vztahy --
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  images       Image[]
  orderItems   OrderItem[]
  customPrices CustomPrice[]

  // Unikátní může být kombinace produktu a SKU
  @@unique([productId, sku])
  @@index([productId])
}
